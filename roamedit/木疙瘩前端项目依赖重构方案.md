木疙瘩前端项目依赖重构方案
---------------------------

木疙瘩前端项目依赖重构方案
   :PROPERTIES:
   :CUSTOM_ID: 木疙瘩前端项目依赖重构方案
   :END:

- 主要存在的问题

  - 发布操作繁琐

    - 其它项目如果需要更新最新代码，需要把resource手动copy到多个项目中，然后再到其它项目中编译后提交到git。需要熟记编译顺序。

  - 易代码冲突

    - 因为把node_modules和dist目录都放在git中进行管理，且每个人基本上都会全部更新这两个目录，所以多人开发中，容易发生代码冲突，且难以的值dist中是否为最新代码

  - 容易造成代码版本混乱

- 想要满足的其它事项

  - 需要保留每个项目的git log

- 整体思路

  - 采用近几年流行的monorepo方案，把相互依赖的多个前端项目放到同一个仓库中
  - 使用yarn workspace，减少第三方工具的引入
  - 把node_modules和dist从git仓库中排除，项目之间直接依赖源码，而非产出物，这样可以保证每次build时的依赖都是最新的。且不易代码冲突
  - s
  - 代码采取服务器build而非本地build，避免因为编译环境不同而产出物不一致

- 可以解决的其它问题

  - 减小git仓库的体积，节约本地的硬盘空间
  - 方便diff代码时没有干扰的变更
  - s

- 对流程的影响

  - 对于新人接触项目的影响

    - 不需要完全搞懂各个项目之间的依赖关系，以及编译的先后顺序就能启动项目和进入开发。

  - 对于日常开发流程的影响

    - 针对一个任务基本在前端只需要新建一个分支，提一次pr就够了
    - 在发布到dev环境和verify环境的时候简化了在本地各种copy的步骤
    - 使用fiddler进行调试的时候，依旧对各个服务进行劫持转发

  - 对于服务器发布的流程

    - 之前是在本地编译好代码，到服务器上面进行相关依赖文件的复制，然后统一拷贝到site项目
    - 现在是在服务器上面使用yarn
      build命令对所有的项目进行build，然后再拷贝产出物到site项目

- 对其它项目的影响

  - 对site项目无影响
  - 需要修改mugeda_auto_build脚本和mugeda_build项目

- 重构步骤

  - 假如新项目名称为front
  - 迁移前的准备

    - 保证所有项目的可以上线的代码都合并到了master
    - 针对每个项目的master都打一个tag，archived，并且checkout一个新分支refactor
    - 项目迁移都是迁移archived上的代码，迁移后的代码发布和提交需要在diff后手动patch到新项目

  - 重构旧项目目录

    - 把旧项目的目录结构改成front的目录结构
    - 新建目录packages/{项目名}

      - 例如packages/mugeda-resource

    - 把就项目的所有文件都移动到packages/{项目名}这个目录下
    - commit这次的改动
    - 然后把所有需要重构的项目都这样修改

  - 合并所有项目

    - 进入到front项目中，目录下应该是空的
    - 把所有需要重构的项目设置成front的remote仓库

      - 例如git remote add mugeda-image ../mugeda-image

    - 逐一merge每个remote仓库的refactor分支

      - 例如git merge mugeda-image/refactor --allow-unrelated-histories
      - 因为每个项目的目录不重复，所有不会有冲突

  - 删除子项目node_modules目录

    - 把子项目对模块的依赖都加入子项目的package.json中
    - 删除目录

  - 删除子项目的dist目录

    - 有些项目是直接引入bundle文件的，把这些子项目简单改造成webpack打包，把引入的bundle文件替换页引入源码
    - 删除dist目录

  - 其它优化

    - 把一些目录层级较深的子项目都提升到packages/下面，并且更新相应的导入代码

  - 测试

    - 修改打包发布脚本，把front发布到新环境，进行全方位的测试

  - 打补丁

    - 把从archived这个tag之后所有的代码变更都手动更新到front项目

  - 上线

- 参考主题

  - [[木疙瘩前端存在问题]]
  - [[优化resource项目的依赖关系]]
